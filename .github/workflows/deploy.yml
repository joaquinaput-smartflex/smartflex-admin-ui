name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true

      - name: Build application
        run: npm run build
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}

      - name: Verify build output
        run: |
          echo "Checking .next directory..."
          ls -la .next/
          test -f .next/BUILD_ID && echo "BUILD_ID exists" || (echo "BUILD_ID missing!" && exit 1)
          test -d .next/static && echo "static/ exists" || (echo "static/ missing!" && exit 1)
          test -d .next/server && echo "server/ exists" || (echo "server/ missing!" && exit 1)

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            .next \
            node_modules \
            package.json \
            package-lock.json \
            next.config.ts

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: deploy.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          scp deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'ENDSSH'
            set -e
            cd ~/smartflex-admin-ui

            # Stop current server
            pkill -f 'next-server' || true
            sleep 2

            # Backup current .next (if it has BUILD_ID, it's valid)
            if [ -f ".next/BUILD_ID" ]; then
              rm -rf .next.backup
              mv .next .next.backup
              echo "Created backup of valid .next"
            else
              rm -rf .next
              echo "Removed incomplete .next"
            fi

            # Extract new build
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz

            # Verify extracted build
            if [ ! -f ".next/BUILD_ID" ]; then
              echo "ERROR: Extracted build is missing BUILD_ID!"
              exit 1
            fi

            # Load nvm
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            # Start the application
            nohup npm start > next.log 2>&1 &

            # Wait for startup with retries
            echo "Waiting for server to start..."
            SUCCESS=0
            for i in 1 2 3 4 5 6; do
              sleep 5
              if curl -s http://localhost:3000 > /dev/null 2>&1; then
                echo "Deployment successful! Server is running."
                SUCCESS=1
                break
              fi
              echo "Attempt $i: Server not ready yet..."
            done

            if [ "$SUCCESS" -eq 1 ]; then
              exit 0
            else
              echo "Server failed to start. Check next.log for errors."
              cat next.log | tail -20
              exit 1
            fi
          ENDSSH

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/smartflex-admin-ui
            if [ -d ".next.backup" ]; then
              rm -rf .next
              mv .next.backup .next
              pkill -f 'next-server' || true
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              nohup npm start > next.log 2>&1 &
              echo "Rolled back to previous version"
            fi
          ENDSSH
