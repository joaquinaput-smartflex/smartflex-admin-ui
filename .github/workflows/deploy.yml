name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true

      - name: Build application
        run: npm run build
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.ts

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: deploy.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          scp deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ~/smartflex-admin-ui

            # Backup current .next
            if [ -d ".next" ]; then
              rm -rf .next.backup
              mv .next .next.backup
            fi

            # Extract new build
            tar -xzf /tmp/deploy.tar.gz
            rm /tmp/deploy.tar.gz

            # Install production dependencies
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            npm ci --production

            # Restart the application
            pkill -f 'next-server' || true
            sleep 2
            nohup npm start > next.log 2>&1 &

            # Verify
            sleep 5
            curl -s http://localhost:3000 > /dev/null && echo "Deployment successful!"
          ENDSSH

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/smartflex-admin-ui
            if [ -d ".next.backup" ]; then
              rm -rf .next
              mv .next.backup .next
              pkill -f 'next-server' || true
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              nohup npm start > next.log 2>&1 &
              echo "Rolled back to previous version"
            fi
          ENDSSH
